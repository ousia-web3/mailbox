<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>하나투어 IT본부 뉴스레터 자동화 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='linear/linear-theme.css') }}">
    <style>
        /* Newsletter Application Specific Styles - Using Linear Design System Variables */

        /* Override body to ensure Linear theme is applied */
        body {
            background-color: var(--color-background-secondary) !important;
            font-family: var(--font-family-primary) !important;
            font-size: var(--font-size-regular) !important;
            line-height: var(--line-height-normal) !important;
            color: var(--color-text-primary) !important;
            margin: 0;
            padding: 0;
            transition: background-color var(--transition-normal), color var(--transition-normal);
        }

        .main-container {
            background-color: var(--color-background-primary);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-lg);
            margin: var(--spacing-6) auto;
            max-width: 1200px;
            overflow: hidden;
            transition: background-color var(--transition-normal), box-shadow var(--transition-normal);
        }

        .header {
            background-color: var(--color-background-primary);
            border-bottom: 1px solid var(--color-neutral-300);
            padding: var(--spacing-8);
            text-align: center;
            transition: background-color var(--transition-normal), border-color var(--transition-normal);
        }

        .header h1 {
            font-size: var(--font-size-title2);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            margin: 0 0 var(--spacing-2) 0;
            line-height: var(--line-height-tight);
        }

        .header p {
            font-size: var(--font-size-heading2);
            color: var(--color-text-secondary);
            margin: 0;
            line-height: var(--line-height-normal);
        }

        .card {
            background-color: var(--color-background-primary);
            border: 1px solid var(--color-neutral-300);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-6);
            transition: all var(--transition-normal);
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
            border-color: var(--color-brand-primary);
        }

        .card-header {
            background-color: var(--color-background-secondary);
            border-bottom: 1px solid var(--color-neutral-300);
            padding: var(--spacing-5) var(--spacing-6);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            font-size: var(--font-size-heading3);
        }

        .card-body {
            padding: var(--spacing-6);
        }

        .btn {
            font-family: var(--font-family-primary);
            font-weight: var(--font-weight-medium);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-3) var(--spacing-5);
            transition: all var(--transition-normal);
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-2);
            text-decoration: none;
            font-size: var(--font-size-regular);
        }

        .btn-primary {
            background: var(--color-brand-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #4f5bb3;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: var(--color-accent-green);
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-warning {
            background: var(--color-accent-orange);
            color: white;
        }

        .btn-warning:hover {
            background: #ff9800;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-outline-danger {
            background: transparent;
            color: var(--color-accent-red);
            border: 1px solid var(--color-accent-red);
        }

        .btn-outline-danger:hover {
            background: var(--color-accent-red);
            color: white;
        }

        .btn-sm {
            padding: var(--spacing-2) var(--spacing-3);
            font-size: var(--font-size-small);
        }

        .status-badge {
            padding: var(--spacing-2) var(--spacing-4);
            border-radius: var(--border-radius-full);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-small);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-1);
        }

        .status-running {
            background: var(--color-accent-green);
            color: white;
        }

        .status-idle {
            background: var(--color-brand-primary);
            color: white;
        }

        .status-error {
            background: var(--color-accent-red);
            color: white;
        }

        .topic-item {
            background-color: var(--color-background-secondary);
            border: 1px solid var(--color-neutral-200);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-5);
            margin-bottom: var(--spacing-4);
            transition: all var(--transition-normal);
        }

        .topic-item:hover {
            border-color: var(--color-brand-primary);
            box-shadow: var(--shadow-sm);
            background-color: var(--color-background-tertiary);
        }

        .keyword-tag {
            background-color: rgba(94, 106, 210, 0.1);
            color: var(--color-brand-primary);
            padding: var(--spacing-1) var(--spacing-3);
            border-radius: var(--border-radius-full);
            font-size: var(--font-size-small);
            font-weight: var(--font-weight-medium);
            margin: var(--spacing-1);
            display: inline-block;
            border: 1px solid rgba(94, 106, 210, 0.2);
        }

        .badge {
            font-weight: var(--font-weight-medium);
            border-radius: var(--border-radius-full);
        }

        .badge.bg-primary {
            background: var(--color-brand-primary) !important;
        }

        .badge.bg-success {
            background: var(--color-accent-green) !important;
        }

        .form-control {
            border: 1px solid var(--color-neutral-300);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-3) var(--spacing-4);
            font-family: var(--font-family-primary);
            font-size: var(--font-size-regular);
            transition: all var(--transition-normal);
            background-color: var(--color-background-primary);
            color: var(--color-text-primary);
        }

        .form-control:focus {
            border-color: var(--color-brand-primary);
            box-shadow: 0 0 0 2px rgba(94, 106, 210, 0.15);
            outline: none;
            background-color: var(--color-background-primary);
        }

        .modal-content {
            border: 1px solid var(--color-neutral-300);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-xl);
            background-color: var(--color-background-primary);
        }

        .modal-header {
            background-color: var(--color-background-secondary);
            border-bottom: 1px solid var(--color-neutral-300);
            padding: var(--spacing-5) var(--spacing-6);
        }

        .modal-body {
            padding: var(--spacing-6);
        }

        .toast {
            border: 1px solid var(--color-neutral-300);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            background-color: var(--color-background-primary);
        }

        .toast-header {
            background-color: var(--color-background-secondary);
            border-bottom: 1px solid var(--color-neutral-300);
        }

        .loading {
            display: none;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        .text-muted {
            color: var(--color-text-tertiary) !important;
        }
        
        /* Linear Design System Integration */
        .rounded-lg { border-radius: var(--border-radius-lg); }
        .rounded-md { border-radius: var(--border-radius-md); }
        .rounded-xl { border-radius: var(--border-radius-xl); }
        
        .p-4 { padding: var(--spacing-4); }
        .mb-4 { margin-bottom: var(--spacing-4); }
        .gap-2 { gap: var(--spacing-2); }
        
        .shadow-sm { box-shadow: var(--shadow-sm); }
        .shadow-md { box-shadow: var(--shadow-md); }
        .shadow-lg { box-shadow: var(--shadow-lg); }

        h5, h6 {
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
        }

        .text-center h5 {
            margin-bottom: var(--spacing-2);
            font-size: var(--font-size-heading3);
        }

        .fs-6 {
            font-size: var(--font-size-regular) !important;
        }

        /* 카드 높이 통일 */
        .row.mb-4 .card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .row.mb-4 .card .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .row.mb-4 .card .card-body p {
            flex: 1;
            margin-bottom: var(--spacing-4);
        }

        .row.mb-4 .card .card-body button {
            margin-top: auto;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-container {
                margin: var(--spacing-4);
                border-radius: var(--border-radius-lg);
            }
            
            .header {
                padding: var(--spacing-6) var(--spacing-4);
            }
            
            .header h1 {
                font-size: var(--font-size-title3);
            }
            
            .card-body {
                padding: var(--spacing-4);
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="container-fluid">
        <div class="main-container">
            <!-- 헤더 -->
            <div class="header">
                <h1><i class="fas fa-newspaper"></i> 하나투어 IT본부 뉴스레터 자동화 시스템</h1>
                <p class="mb-0"> • 뉴스 수집 • AI 요약 • 이메일 발송</p>
            </div>

            <!-- 메인 컨텐츠 -->
            <div class="p-4">
                <!-- 시스템 상태 -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-info-circle"></i> 시스템 상태
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h5>상태</h5>
                                            <span id="systemStatus" class="status-badge status-idle">대기 중</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h5>주제 수</h5>
                                            <span id="topicsCount" class="badge bg-primary fs-6">0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h5>수신자 수</h5>
                                            <span id="receiverCount" class="badge bg-success fs-6">0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h5>마지막 실행</h5>
                                            <span id="lastRun" class="text-muted">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 주요 기능 -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-cogs"></i> 키워드 설정
                            </div>
                            <div class="card-body">
                                <p>뉴스 수집을 위한 키워드와 주제를 설정합니다.</p>
                                <button class="btn btn-primary w-100" onclick="showKeywordModal()">
                                    <i class="fas fa-edit"></i> 키워드 관리
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-users"></i> 수신자 관리
                            </div>
                            <div class="card-body">
                                <p>뉴스레터 수신자를 추가, 제거, 관리합니다.</p>
                                <button class="btn btn-success w-100" onclick="openRecipientManagement()">
                                    <i class="fas fa-users"></i> 수신자 관리
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-vial"></i> 시스템 테스트
                            </div>
                            <div class="card-body">
                                <p>뉴스 수집, 요약, 이메일 발송 기능을 테스트합니다.</p>
                                <button class="btn btn-warning w-100" onclick="runTest()" id="testBtn">
                                    <i class="fas fa-play"></i> 테스트 실행
                                    <span class="loading spinner-border spinner-border-sm ms-2"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-paper-plane"></i> 뉴스레터 생성
                            </div>
                            <div class="card-body">
                                <p>뉴스레터를 생성하고 발송합니다.</p>
                                <button id="generateBtn" class="btn btn-primary w-100" onclick="generateNewsletter()">
                                    <i class="fas fa-paper-plane"></i> 뉴스레터 생성 및 발송
                                    <span class="loading spinner-border spinner-border-sm ms-2"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 설정된 주제 목록 -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-list"></i> 설정된 주제 목록
                            </div>
                            <div class="card-body">
                                <div id="topicsList">
                                    <p class="text-muted text-center">주제를 추가해주세요.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 키워드 설정 모달 -->
    <div class="modal fade" id="keywordModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-cogs"></i> 키워드 설정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 주제 추가 폼 -->
                    <div class="mb-4">
                        <h6><i class="fas fa-plus"></i> 새 주제 추가</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="topicName" placeholder="주제 이름">
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="topicKeywords" placeholder="키워드 (쉼표로 구분)">
                            </div>
                            <div class="col-md-2">
                                <input type="number" class="form-control" id="topicWeight" placeholder="비중" min="1" max="100" value="20">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="addTopic()">
                                    <i class="fas fa-plus"></i> 추가
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 기존 주제 목록 -->
                    <div id="existingTopics">
                        <!-- 동적으로 생성됨 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 알림 토스트 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-bell me-2"></i>
                <strong class="me-auto">알림</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                메시지가 여기에 표시됩니다.
            </div>
        </div>
    </div>

    <!-- 미리보기 모달 -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">
                        <i class="fas fa-eye"></i> 뉴스레터 미리보기
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <iframe id="previewFrame" style="width: 100%; height: 70vh; border: none;"></iframe>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> 닫기
                    </button>
                    <button type="button" class="btn btn-primary" onclick="generateNewsletter(); bootstrap.Modal.getInstance(document.getElementById('previewModal')).hide();">
                        <i class="fas fa-paper-plane"></i> 이대로 발송하기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 전역 변수
        let topics = [];
        let systemStatus = {};
        let statusUpdateTimer = null;
        let lastStatusCheck = 0;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadStatus();
            loadTopics();
            // 5초마다 자동 업데이트 제거 - 필요할 때만 업데이트
        });

        // 시스템 상태 로드 (개선된 버전)
        async function loadStatus(force = false) {
            const now = Date.now();
            
            // 강제 업데이트가 아니고, 마지막 체크 후 15초가 지나지 않았다면 스킵 (30초에서 15초로 단축)
            if (!force && (now - lastStatusCheck) < 15000) {
                return;
            }
            
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.status === 'success') {
                    systemStatus = data.system_status;
                    updateStatusDisplay(data);
                    lastStatusCheck = now;
                    
                    // 실행 중이면 5초 후 다시 체크, 아니면 30초 후 체크 (더 빠른 업데이트)
                    if (data.system_status.is_running) {
                        if (statusUpdateTimer) clearTimeout(statusUpdateTimer);
                        statusUpdateTimer = setTimeout(() => loadStatus(), 5000);
                    } else {
                        if (statusUpdateTimer) clearTimeout(statusUpdateTimer);
                        statusUpdateTimer = setTimeout(() => loadStatus(), 30000);
                    }
                }
            } catch (error) {
                console.error('상태 로드 실패:', error);
                // 에러 발생 시 15초 후 재시도 (30초에서 15초로 단축)
                if (statusUpdateTimer) clearTimeout(statusUpdateTimer);
                statusUpdateTimer = setTimeout(() => loadStatus(), 15000);
            }
        }

        // 상태 표시 업데이트
        function updateStatusDisplay(data) {
            const statusElement = document.getElementById('systemStatus');
            const topicsCountElement = document.getElementById('topicsCount');
            const receiverCountElement = document.getElementById('receiverCount');
            const lastRunElement = document.getElementById('lastRun');

            // 상태 업데이트
            if (data.system_status.is_running) {
                statusElement.textContent = '실행 중';
                statusElement.className = 'status-badge status-running';
            } else {
                statusElement.textContent = data.system_status.status_message;
                statusElement.className = 'status-badge status-idle';
            }

            // 카운트 업데이트
            topicsCountElement.textContent = data.topics_count;
            receiverCountElement.textContent = data.receiver_count;
            
            // 수신자 통계 정보 업데이트 (있는 경우)
            if (data.recipient_stats) {
                const stats = data.recipient_stats;
                receiverCountElement.textContent = `${stats.active}/${stats.total}`;
                receiverCountElement.title = `활성: ${stats.active}명, 전체: ${stats.total}명, 비활성: ${stats.inactive}명`;
            }

            // 마지막 실행 시간
            if (data.system_status.last_run) {
                const date = new Date(data.system_status.last_run);
                lastRunElement.textContent = date.toLocaleString('ko-KR');
            } else {
                lastRunElement.textContent = '-';
            }
        }

        // 주제 목록 로드
        async function loadTopics() {
            try {
                const response = await fetch('/api/keywords');
                const data = await response.json();
                
                if (data.status === 'success') {
                    topics = data.topics;
                    displayTopics();
                }
            } catch (error) {
                console.error('주제 로드 실패:', error);
            }
        }

        // 주제 목록 표시
        function displayTopics() {
            const topicsListElement = document.getElementById('topicsList');
            const existingTopicsElement = document.getElementById('existingTopics');

            if (topics.length === 0) {
                topicsListElement.innerHTML = '<p class="text-muted text-center">주제를 추가해주세요.</p>';
                existingTopicsElement.innerHTML = '<p class="text-muted text-center">설정된 주제가 없습니다.</p>';
                return;
            }

            // 메인 페이지 주제 목록
            let topicsHtml = '';
            topics.forEach((topic, index) => {
                topicsHtml += `
                    <div class="topic-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-2">${topic.name} <span class="badge bg-primary">${topic.weight}%</span></h6>
                                <div>
                                    ${topic.keywords.map(keyword => `<span class="keyword-tag">${keyword}</span>`).join('')}
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTopic('${topic.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            topicsListElement.innerHTML = topicsHtml;

            // 모달 내 주제 목록
            let modalTopicsHtml = '<h6><i class="fas fa-list"></i> 기존 주제</h6>';
            topics.forEach((topic, index) => {
                modalTopicsHtml += `
                    <div class="topic-item mb-3">
                        <div class="row">
                            <div class="col-md-3">
                                <input type="text" class="form-control" value="${topic.name}" id="editName${index}">
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" value="${topic.keywords.join(', ')}" id="editKeywords${index}">
                            </div>
                            <div class="col-md-2">
                                <input type="number" class="form-control" value="${topic.weight}" min="1" max="100" id="editWeight${index}">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-sm btn-primary" onclick="updateTopic('${topic.name}', ${index})">
                                    <i class="fas fa-save"></i> 저장
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTopic('${topic.name}')">
                                    <i class="fas fa-trash"></i> 삭제
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            existingTopicsElement.innerHTML = modalTopicsHtml;
        }

        // 키워드 모달 표시
        function showKeywordModal() {
            const modal = new bootstrap.Modal(document.getElementById('keywordModal'));
            modal.show();
        }

        // 주제 추가
        async function addTopic() {
            const name = document.getElementById('topicName').value.trim();
            const keywordsText = document.getElementById('topicKeywords').value.trim();
            const weight = parseInt(document.getElementById('topicWeight').value);

            if (!name || !keywordsText) {
                showNotification('주제 이름과 키워드를 입력해주세요.', 'warning');
                return;
            }

            const keywords = keywordsText.split(',').map(k => k.trim()).filter(k => k);

            try {
                const response = await fetch('/api/keywords', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'add',
                        name: name,
                        keywords: keywords,
                        weight: weight
                    })
                });

                const data = await response.json();
                showNotification(data.message, data.status === 'success' ? 'success' : 'error');
                
                if (data.status === 'success') {
                    document.getElementById('topicName').value = '';
                    document.getElementById('topicKeywords').value = '';
                    loadTopics();
                    loadStatus();
                }
            } catch (error) {
                showNotification('주제 추가 중 오류가 발생했습니다.', 'error');
            }
        }

        // 주제 수정
        async function updateTopic(oldName, index) {
            const name = document.getElementById(`editName${index}`).value.trim();
            const keywordsText = document.getElementById(`editKeywords${index}`).value.trim();
            const weight = parseInt(document.getElementById(`editWeight${index}`).value);

            if (!name || !keywordsText) {
                showNotification('주제 이름과 키워드를 입력해주세요.', 'warning');
                return;
            }

            const keywords = keywordsText.split(',').map(k => k.trim()).filter(k => k);

            try {
                const response = await fetch('/api/keywords', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'update',
                        topic_name: oldName,
                        name: name,
                        keywords: keywords,
                        weight: weight
                    })
                });

                const data = await response.json();
                showNotification(data.message, data.status === 'success' ? 'success' : 'error');
                
                if (data.status === 'success') {
                    loadTopics();
                    loadStatus();
                }
            } catch (error) {
                showNotification('주제 수정 중 오류가 발생했습니다.', 'error');
            }
        }

        // 주제 삭제
        async function deleteTopic(topicName) {
            if (!confirm(`정말로 "${topicName}" 주제를 삭제하시겠습니까?`)) {
                return;
            }

            try {
                const response = await fetch('/api/keywords', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'delete',
                        topic_name: topicName
                    })
                });

                const data = await response.json();
                showNotification(data.message, data.status === 'success' ? 'success' : 'error');
                
                if (data.status === 'success') {
                    loadTopics();
                    loadStatus();
                }
            } catch (error) {
                showNotification('주제 삭제 중 오류가 발생했습니다.', 'error');
            }
        }

        // 테스트 실행
        async function runTest() {
            const btn = document.getElementById('testBtn');
            const loading = btn.querySelector('.loading');
            
            btn.disabled = true;
            loading.style.display = 'inline-block';

            try {
                const response = await fetch('/api/test', {
                    method: 'POST'
                });

                const data = await response.json();
                showNotification(data.message, data.status === 'success' ? 'success' : 'error');
                
                // 테스트 시작 후 백그라운드 완료까지 상태 모니터링
                if (data.status === 'success') {
                    // 즉시 상태 업데이트
                    loadStatus(true);
                    
                    // 백그라운드 완료까지 주기적으로 상태 체크
                    const checkTestCompletion = async () => {
                        try {
                            const statusResponse = await fetch('/api/status');
                            const statusData = await statusResponse.json();
                            
                            if (statusData.status === 'success') {
                                // 실행 중이 아니면 완료된 것으로 간주
                                if (!statusData.system_status.is_running) {
                                    // 완료 후 최종 상태 업데이트
                                    loadStatus(true);
                                    showNotification('시스템 테스트가 완료되었습니다!', 'success');
                                    btn.disabled = false;
                                    loading.style.display = 'none';
                                    return;
                                }
                            }
                            
                            // 아직 실행 중이면 3초 후 다시 체크
                            setTimeout(checkTestCompletion, 3000);
                        } catch (error) {
                            console.error('테스트 상태 체크 실패:', error);
                            // 에러 발생 시 5초 후 재시도
                            setTimeout(checkTestCompletion, 5000);
                        }
                    };
                    
                    // 3초 후부터 상태 체크 시작
                    setTimeout(checkTestCompletion, 3000);
                } else {
                    btn.disabled = false;
                    loading.style.display = 'none';
                }
            } catch (error) {
                showNotification('테스트 실행 중 오류가 발생했습니다.', 'error');
                btn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // 뉴스레터 생성
        async function generateNewsletter() {
            const btn = document.getElementById('generateBtn');
            const loading = btn.querySelector('.loading');
            
            btn.disabled = true;
            loading.style.display = 'inline-block';

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST'
                });

                const data = await response.json();
                showNotification(data.message, data.status === 'success' ? 'success' : 'error');
                
                // 뉴스레터 생성 시작 후 백그라운드 완료까지 상태 모니터링
                if (data.status === 'success') {
                    // 즉시 상태 업데이트
                    loadStatus(true);
                    
                    // 백그라운드 완료까지 주기적으로 상태 체크
                    const checkCompletion = async () => {
                        try {
                            const statusResponse = await fetch('/api/status');
                            const statusData = await statusResponse.json();
                            
                            if (statusData.status === 'success') {
                                // 실행 중이 아니면 완료된 것으로 간주
                                if (!statusData.system_status.is_running) {
                                    // 완료 후 최종 상태 업데이트
                                    loadStatus(true);
                                    showNotification('뉴스레터 발송이 완료되었습니다!', 'success');
                                    return;
                                }
                            }
                            
                            // 아직 실행 중이면 3초 후 다시 체크 (더 빠른 체크)
                            setTimeout(checkCompletion, 3000);
                        } catch (error) {
                            console.error('상태 체크 실패:', error);
                            // 에러 발생 시 5초 후 재시도
                            setTimeout(checkCompletion, 5000);
                        }
                    };
                    
                    // 3초 후부터 상태 체크 시작 (더 빠른 시작)
                    setTimeout(checkCompletion, 3000);
                }
            } catch (error) {
                showNotification('뉴스레터 생성 중 오류가 발생했습니다.', 'error');
            } finally {
                btn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // 뉴스레터 미리보기
        async function previewNewsletter() {
            const btn = document.getElementById('previewBtn');
            const loading = btn.querySelector('.loading');
            
            btn.disabled = true;
            loading.style.display = 'inline-block';

            try {
                const response = await fetch('/api/preview', {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    // 모달 팝업으로 미리보기 표시
                    showPreviewModal(data.preview);
                    showNotification('미리보기를 생성했습니다.', 'success');
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                showNotification('뉴스레터 미리보기 중 오류가 발생했습니다.', 'error');
            } finally {
                btn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // 미리보기 모달 표시
        function showPreviewModal(htmlContent) {
            const iframe = document.getElementById('previewFrame');
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            
            // iframe에 HTML 내용 삽입
            iframe.onload = function() {
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                doc.open();
                doc.write(htmlContent);
                doc.close();
            };
            
            // 빈 페이지로 시작해서 내용 로드
            iframe.src = 'about:blank';
            
            // 모달 표시
            modal.show();
        }

        // 수신자 관리 페이지 열기
        function openRecipientManagement() {
            // 새 탭에서 수신자 관리 페이지 열기
            window.open('/recipients', '_blank');
        }

        // 알림 표시
        function showNotification(message, type) {
            const toast = document.getElementById('notificationToast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            
            // 토스트 색상 설정
            const toastHeader = toast.querySelector('.toast-header');
            toastHeader.className = 'toast-header';
            
            if (type === 'success') {
                toastHeader.classList.add('bg-success', 'text-white');
            } else if (type === 'error') {
                toastHeader.classList.add('bg-danger', 'text-white');
            } else if (type === 'warning') {
                toastHeader.classList.add('bg-warning', 'text-dark');
            }
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
    </script>
</body>
</html> 