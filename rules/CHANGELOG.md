# 변경 이력 (CHANGELOG)

이 문서는 프로젝트의 주요 수정, 개선, 오류 조치 이력을 기록합니다.
AI는 작업 완료 후 이 문서를 갱신해야 합니다.

## 양식 가이드

- **날짜**: YYYY-MM-DD
- **변경 대상**: 수정된 파일명 또는 모듈
- **유형**: [오류수정], [리팩토링], [기능개선], [문서화]
- **내용**:
  - **문제 요약**: 무엇이 문제였는지 간단히
  - **수정 내용**: 어떻게 고쳤는지
  - **재발 방지**: 향후 주의할 점

---

## 2026-01-15

- **변경 대상**: AI 규칙 문서 구조
- **유형**: [리팩토링]
- **문제 요약**: `.cursor` 폴더명이 특정 도구에 종속적이며, 실행 제한 규칙이 과도하게 엄격함
- **수정 내용**:
  - `.cursor` 폴더를 `.ai`로 변경하여 범용성 확보
  - `instructions.md` 내 "자동 실행 금지" 조항을 완화하고 `EXEC_POLICY.md`를 따르도록 수정
  - `README.md` 링크 업데이트
- **재발 방지**: 도구 종속적인 네이밍 지양

- **변경 대상**: 전체 프로젝트 구조
- **유형**: [문서화]
- **문제 요약**: 체계적인 AI 협업 규칙 및 오류 관리 시스템 부재
- **수정 내용**:
  - `.cursor/instructions.md` 생성 (이후 `.ai/`로 이동)
  - `rules/EXEC_POLICY.md` 생성
  - `rules/CHANGELOG.md` 생성
  - `logs/ERROR_HISTORY.md` 생성
  - `README.md` 업데이트
- **재발 방지**: 이후 모든 작업은 본 규칙 문서를 기준으로 수행하여 커뮤니케이션 비용 및 오류 최소화

- **변경 대상**: AI 규칙 및 초기화 스크립트
- **유형**: [기능개선]
- **문제 요약**: 초기화 규칙 명시 부재 및 자동 생성 파일 보호 정책 필요
- **수정 내용**:
  - `setup_ai_rules.py` 업데이트 (초기화, 보호, 예방 조치 규칙 추가)
  - `.ai/instructions.md` 업데이트 (0. 프로젝트 초기화 규칙 추가, 2. 코드 수정 원칙 보완, 3. 오류 관리 보완)
- **재발 방지**: 자동 생성된 기준 문서의 무단 변경 방지 및 잠재적 오류 예방 기록 습관화

- **변경 대상**: `news_summarizer_v2.py`
- **유형**: [오류수정]
- **문제 요약**: 시스템 초기화 시 `Client.__init__() got an unexpected keyword argument 'proxies'` 오류 발생
- **수정 내용**: `OpenAI` 클라이언트 초기화 코드를 `http_client=httpx.Client()`를 명시적으로 전달하도록 수정
- **재발 방지**: 라이브러리 호환성 문제 발생 시 명시적 객체 주입 패턴 사용

- **변경 대상**: `newsletter_system.py`, `prompts/newsletter_template_prompt.md`
- **유형**: [기능개선]
- **문제 요약**:
  - AI Insight 카테고리 뉴스 제목 및 요약 품질 저하 (제목 반복 등)
  - 뉴스 카드 개수와 'In Other News' 목록 개수 불일치
  - 'In Other News' 제목 글자수 제한 필요
- **수정 내용**:
  - `newsletter_system.py`: 'In Other News' 섹션을 AI 생성 결과에 의존하지 않고, 파싱된 뉴스 카드를 기반으로 프로그램에서 자동 생성하도록 로직 변경 (개수 일치 보장)
  - `newsletter_system.py`: 'In Other News' 생성 시 제목 50자 제한(말줄임표) 로직 추가
  - `prompts/newsletter_template_prompt.md`: AI Insight 요약 품질 강화를 위한 지침 추가 (제목 복사 금지, 재구성 필수) 및 'In Other News' 생성 지침 삭제
- **재발 방지**: 데이터 일관성이 중요한 섹션은 AI 생성보다 로직 기반 생성을 우선 고려

- **변경 대상**: `newsletter_system.py`
- **유형**: [기능개선]
- **문제 요약**: 'In Other News' 섹션에 AI가 요약한 제목이 아닌 원문 제목을 사용하고 싶음
- **수정 내용**: `link`를 키로 사용하여 원본 뉴스 데이터에서 원문 제목을 조회하고, 이를 'In Other News' 목록 생성 시 우선적으로 사용하도록 로직 변경 (50자 제한 유지)
- **재발 방지**: 사용자 요구사항(원문 vs 요약)을 명확히 구분하여 데이터 소스를 결정해야 함

- **변경 대상**: `newsletter_system.py`
- **유형**: [오류수정]
- **문제 요약**: 본문 수집에 실패한 뉴스에 대해 AI가 제목만 보고 내용을 지어내는 환각(Hallucination) 현상 발생
- **수정 내용**: 뉴스 수집 후 `full_content`와 `content_preview`의 길이를 검사하여, 내용이 부실한 뉴스는 요약 대상에서 아예 제외하는 필터링 로직 추가
- **재발 방지**: LLM 입력 데이터의 품질 검증(Pre-validation) 절차 필수화

- **변경 대상**: `prompts/newsletter_template_prompt.md`
- **유형**: [기능개선]
- **문제 요약**: AI가 뉴스 요약 시 제목을 그대로 복사하여 붙여넣는 현상 지속 (품질 저하)
- **수정 내용**: 프롬프트에 **Bad Case(제목 복사)**와 **Good Case(내용 재구성)** 예시를 명시적으로 추가하여 AI가 올바른 요약 방식을 따르도록 유도
- **재발 방지**: LLM에게 지시할 때는 추상적인 규칙보다 **구체적인 예시(Few-shot)**가 훨씬 효과적임

- **변경 대상**: `news_collector_working.py`
- **유형**: [기능개선]
- **문제 요약**: 뉴스 사이트 구조 다양성으로 인해 본문 추출 실패율이 높음 (특히 AI Insight 관련 뉴스)
- **수정 내용**: `extract_full_content` 메서드 개선
  - Fallback 1: `og:description`, `description` 메타 태그에서 요약문 추출
  - Fallback 2: 본문 영역을 못 찾을 경우, 페이지 내 모든 `<p>` 태그 중 의미 있는 길이(30자 이상)의 텍스트를 수집하여 본문으로 구성

- **변경 대상**: `news_summarizer_v2.py`
- **유형**: [코드정리]
- **수정 내용**: `summarize_topic_with_persona` 메서드 내 사용하지 않는 하드코딩된 프롬프트 템플릿(비상용) 삭제

- **변경 대상**: `newsletter_system.py`
- **유형**: [오류수정]
- **문제 요약**: 뉴스레터 생성 실패 시 구형 템플릿(보라색 헤더)으로 자동 전환(Fallback)되어 일관성 없는 디자인 발송
- **수정 내용**: `generate_newsletter_content_new_template` 메서드 내의 구형 템플릿 Fallback 로직 삭제. V3 템플릿 생성 실패 시 발송 중단하도록 변경.
- **변경 대상**: `newsletter_system.py`

- **유형**: [기능개선]
- **문제 요약**: 시스템 테스트(`run_test`)의 뉴스 수집 로직이 실제 운영 로직과 달라(약식 수집), 테스트 결과의 신뢰성 부족
- **수정 내용**: `run_test` 메서드 내 뉴스 수집 부분을 `collect_news_for_topic` 메서드 호출로 변경하여 실제 운영과 동일한 조건(모든 키워드, 중복 제거 등)으로 수행되도록 수정
- **재발 방지**: 테스트 코드는 가능한 한 실제 운영 코드와 동일한 경로(Method)를 타도록 설계하여 환경 차이에 따른 오류를 최소화해야 함

- **변경 대상**: `news_collector_working.py`
- **유형**: [오류수정]
- **문제 요약**: 구글 뉴스 수집 시 리다이렉트 링크(`news.google.com/read/...`)가 연결되지 않거나 깨지는 현상 발생
- **수정 내용**: 뉴스 수집 단계에서 링크 유효성 검사(Validation) 로직 추가
  - 링크 접속 시도(GET) 후 응답 코드가 200(성공)이 아니면 수집 대상에서 즉시 제외
  - 접속 성공 시, 리다이렉트된 최종 목적지 URL(실제 언론사 링크)로 링크 정보를 업데이트하여 뉴스레터에 제공
- **재발 방지**: 외부 링크 수집 시에는 반드시 연결 가능 여부를 사전 검증(Pre-check)하고, 리다이렉트 최종 경로를 확보해야 함

- **변경 대상**: `prompts/newsletter_template_prompt.md`, `newsletter_system.py`
- **유형**: [기능개선]
- **문제 요약**: 뉴스레터 카테고리별 표시되는 뉴스 개수가 3개로 적어 정보량이 부족함
- **수정 내용**:
  - 프롬프트: 각 카테고리별 선정 뉴스 개수를 "3~5개"에서 "**5개 이상**"으로 상향 조정
  - 시스템: AI 파싱 결과가 **5개 미만**일 경우, 원본 뉴스 데이터를 사용하여 5개를 채우도록 Fallback 기준 강화
- **재발 방지**: 콘텐츠 풍부성을 위해 최소 수량을 명시적으로 관리하고, 부족 시 자동 보완 로직을 강화해야 함

- **변경 대상**: `news_collector_working.py`
- **유형**: [오류수정]
- **문제 요약**: 구글 뉴스 링크 중 JS 리다이렉트가 필요한 경우(예: `news.google.com/read/...`) 일반 HTTP 요청으로는 최종 URL 확보가 불가능하여 연결되지 않는 링크가 포함됨
- **수정 내용**: 링크 유효성 검증 로직 강화
  - 리다이렉트 추적 후에도 최종 URL이 여전히 `news.google.com` 또는 `google.com/read`를 포함하는 경우, 리다이렉트 실패로 간주하여 수집 대상에서 제외
- **재발 방지**: 크롤러가 처리할 수 없는 복잡한 리다이렉트(JS 기반 등) 링크는 사용자 경험을 위해 과감히 필터링하는 정책 적용

- **변경 대상**: `newsletter_system.py`
- **유형**: [오류수정]
- **문제 요약**: 시스템 테스트(`run_test`) 시 이메일 발송이 실패해도 결과가 '성공'으로 반환되어 사용자가 발송 성공으로 오인함
- **수정 내용**: 이메일 발송 단계 실패 시 `run_test` 메서드가 `False`를 반환하고 Error 로그를 남기도록 수정
- **재발 방지**: 테스트 기능은 각 단계별 성공/실패 여부를 명확히 검증하고, 최종 결과에 반영해야 함

- **변경 대상**: `newsletter_system.py`, `news_collector_working.py`
- **유형**: [오류수정]
- **문제 요약**: 테스트(`run_test`)에서는 뉴스가 수집되나 실제 발송(`generate_newsletter`) 시에는 뉴스가 0개로 처리되어 빈 뉴스레터가 발송됨 (필터링 로직 불일치)
- **수정 내용**:
  - `generate_newsletter`의 본문 길이 필터링 기준을 50자에서 **30자**로 완화
  - `run_test`에도 동일한 필터링 로직을 적용하여 테스트와 운영 환경의 일관성 확보
  - `news_collector_working.py`에서 본문 추출 실패 시 생성되는 대체 텍스트 길이를 늘려 필터링에 걸리지 않도록 수정
- **재발 방지**: 테스트 코드는 운영 코드의 제약 조건(필터링 등)을 동일하게 반영해야 정확한 테스트가 가능함

- **변경 대상**: `news_collector_working.py`
- **유형**: [오류수정]
- **문제 요약**: 뉴스 수집 시 구글 뉴스 검색이 실패하거나 로그가 누락되어 수집 여부 확인 불가, 네이버 뉴스 API 검색이 비활성화되어 있음
- **수정 내용**:
  - `search_google_news` 메서드 진입 로그 추가 및 User-Agent 랜덤 변경 로직 적용 (차단 회피)
  - `multi_search_news`에서 구글 뉴스 검색 실패 시 ERROR 레벨 로그 출력
  - 주석 처리되어 있던 네이버 뉴스 API 검색 로직 활성화 (수집 소스 다변화)
- **재발 방지**: 외부 사이트 크롤링 시 차단 가능성을 항상 염두에 두고 User-Agent 회전 및 명확한 실패 로그를 남겨야 함

- **변경 대상**: `news_collector_working.py`
- **유형**: [오류수정]
- **문제 요약**: 구글 뉴스 링크(`news.google.com/read/...`)가 JS 리다이렉트 방식인 경우, `requests`로 최종 URL을 얻지 못해 수집 대상에서 제외되어 결과가 0건이 되는 문제
- **수정 내용**:
  - 리다이렉트 추적 실패(구글 뉴스 도메인 유지) 시에도 해당 링크를 버리지 않고 수집하도록 정책 변경
  - 구글 뉴스 링크인 경우 본문 추출을 시도하지 않고 "뉴스 원문 보기를 통해 상세 내용을 확인해 주세요."라는 안내 문구로 대체
- **재발 방지**: 크롤러의 기술적 한계(JS 미지원)로 인해 완벽한 수집이 불가능할 경우, 사용자 경험을 해치지 않는 선에서 우회(Fallback)하거나 안내 메시지를 제공하는 유연한 처리가 필요함

- **변경 대상**: `news_collector_working.py`
- **유형**: [오류수정]
- **문제 요약**: 구글 뉴스 URL에 대해 날짜 검증을 건너뛰도록 설정되어, 기준 날짜 범위를 벗어난 오래된 뉴스까지 수집되는 문제
- **수정 내용**:
  - 구글 뉴스 URL에 대한 날짜 검증 건너뛰기 로직 제거
  - 날짜 추출 실패 시, 범위 날짜인 경우 종료일을 사용하여 유효한 날짜 형식 보장
  - 모든 뉴스 소스(구글 뉴스 포함)를 ±1일 이내만 수집되도록 검증 기준 강화 (기존: ±2일)
- **재발 방지**: 모든 뉴스 소스는 동일한 날짜 검증 기준을 적용하여 일관성을 유지해야 함. 뉴스 품질 향상을 위해 날짜 범위는 더 엄격하게 관리해야 함

- **변경 대상**: `.env`
- **유형**: [오류수정]
- **문제 요약**: 네이버 뉴스 API 호출 시 401 Unauthorized 에러 발생 (잘못된 키 사용)
- **수정 내용**:
  - `.env` 파일의 `NAVER_CLIENT_ID`, `NAVER_CLIENT_SECRET` 값을 유효한 네이버 개발자 센터 발급 키로 갱신
  - API 호출 테스트를 통해 200 OK 응답 확인
- **재발 방지**: API 키 적용 시 해당 키가 사용하려는 서비스(예: 검색 API vs 클라우드 플랫폼)에 맞는 키인지 사전 검증이 필요함

---

## 2026-01-16

- **변경 대상**: `news_summarizer_v2.py`, `.env`
- **유형**: [기능개선]
- **문제 요약**: OpenAI API 키 오류로 뉴스 요약 생성 실패 (401 Unauthorized)
- **수정 내용**:
  - OpenAI API에서 Google Gemini API로 전환
  - `news_summarizer_v2.py`: OpenAI 클라이언트를 Gemini GenerativeModel로 교체
  - `.env`: `GEMINI_API_KEY`, `GEMINI_MODEL` 환경 변수 추가 (gemini-2.5-flash-preview-09-2025)
  - API 호출 구조 변경: `chat.completions.create()` → `generate_content()`
- **재발 방지**: API 서비스 변경 시 환경 변수 및 클라이언트 초기화 로직을 함께 검토해야 함

- **변경 대상**: `news_summarizer_v2.py`
- **유형**: [오류수정]
- **문제 요약**: Gemini API 응답 완료 후 "AI 요약 실패" 에러 발생 (응답이 빈 문자열 또는 None 반환)
- **수정 내용**:
  - Gemini API 응답 상태 검증 로직 추가 (candidates 확인, finish_reason 체크, safety_ratings 로깅)
  - 빈 응답 처리: 결과가 비어있으면 명시적으로 None 반환 및 에러 로그 출력
  - 디버그 로그 강화: 응답 길이, finish_reason, 예외 스택트레이스 출력
  - `summarize_topic_with_persona`와 `summarize_all_news` 두 함수 모두 동일하게 수정
- **재발 방지**: 생성형 AI API 응답은 항상 상태를 검증하고, 빈 응답이나 차단된 응답에 대한 명시적 에러 처리가 필요함

- **변경 대상**: `news_summarizer_v2.py`
- **유형**: [오류수정]
- **문제 요약**: finish_reason=2 (MAX_TOKENS) 오류로 Gemini API 응답이 잘려서 빈 응답 처리됨
- **수정 내용**:
  - `max_output_tokens` 증가: `summarize_all_news` (3000→8000), `summarize_topic_with_persona` (2000→4000)
  - finish_reason=2 (MAX_TOKENS) 시에도 부분 응답을 사용하도록 로직 수정
  - finish_reason이 1(STOP) 또는 2(MAX_TOKENS)인 경우 정상 처리, 그 외는 에러로 간주
- **재발 방지**: 출력 토큰 한계를 충분히 설정하고, MAX_TOKENS 응답도 유효한 부분 결과로 처리해야 함

- **변경 대상**: `news_summarizer_v2.py`, `newsletter_system.py`
- **유형**: [오류수정]
- **문제 요약**: 339개의 전체 뉴스를 Gemini에 전달하여 입력 토큰 한계 초과 (근본 원인)
- **수정 내용**:
  - `newsletter_system.py`: 뉴스 객체에 category 필드 추가 (lines 237, 472)
  - `news_summarizer_v2.py`: 카테고리별로 최대 15개씩만 선택하여 Gemini에 전달 (line 155-170)
  - 총 339개 → 최대 45개(3개 카테고리 × 15개)로 입력 토큰 대폭 감소
- **재발 방지**: 입력 데이터 크기를 사전에 제한하여 토큰 한계를 예방해야 함. 프롬프트에서 선택하도록 할 때도 입력을 적정 수준으로 제한

- **변경 대상**: `news_collector_working.py`
- **유형**: [기능개선]
- **문제 요약**: 네이버 API 사용으로 인한 불필요한 API 호출 및 401 에러 발생
- **수정 내용**:
  - `multi_search_news` 함수의 네이버 뉴스 API 호출 비활성화 (lines 192-205)
  - 네이버 뉴스 크롤링 비활성화 (lines 220-234)
  - 구글 뉴스와 일반 뉴스 사이트만 사용
- **재발 방지**: 외부 API 의존도를 줄이고 필요한 소스만 활성화하여 안정성 향상

- **변경 대상**: `prompts/newsletter_template_prompt.md`
- **유형**: [오류수정], [기능개선]
- **문제 요약**:
  - AI가 뉴스 요약 결과를 마크다운 표(Table) 형식으로 출력하여 시스템 파싱 실패 (요약 누락)
  - 뉴스 선정 시 명확한 기준이 없어 AI가 임의로 뉴스를 선택함
- **수정 내용**:
  - **포맷 강제**: "절대 표(Table) 형식을 사용하지 말 것"과 "요약은 반드시 한 줄로 작성할 것"이라는 강력한 제약 조건 추가
  - **선정 기준 명시**: 뉴스 선정 시 **중요도(키워드 연관성)**, **시의성(최신순)**, **정보 가치(수치/통계 포함)**의 3가지 구체적 기준을 프롬프트에 추가
- **재발 방지**: LLM의 출력 형식이 시스템 파싱 로직과 맞지 않을 경우, 프롬프트에서 해당 형식을 명시적으로 금지(Negative Constraint)해야 함

- **변경 대상**: `news_summarizer_v2.py`
- **유형**: [오류수정]
- **문제 요약**: `ValueError: The response.text quick accessor only works for simple (single-Part) text responses.` 오류 발생
- **수정 내용**: Gemini API 응답이 Multi-part일 경우 `response.text` 접근이 불가능하므로, `candidates[0].content.parts`를 순회하여 텍스트를 추출하는 예외 처리 로직 추가
- **재발 방지**: 생성형 AI API의 응답 구조 가변성에 대비하여 단순 접근자 외에 안전한 파싱 로직을 항상 구현해야 함

---

## 2026-01-19

- **변경 대상**: `start_web_app.bat`
- **유형**: [오류수정]
- **문제 요약**: `start_web_app.bat` 실행 시 반응이 없거나 실행이 너무 오래 걸리는 현상 (py 런처 호환성 문제 추정)
- **수정 내용**:
  - `py` 런처 및 `where` 명령어를 사용하는 복잡한 분기 로직 제거
  - 현재 환경에서 검증된 `python` 명령어를 직접 실행하도록 단순화
  - `start` 명령어로 새 창을 띄우는 대신 현재 창에서 실행하여 로그 확인이 가능하도록 변경
  - (추가) 실행 종료 후 창이 바로 닫히지 않도록 스크립트 마지막에 `pause` 강제 추가
  - (추가) `python` 명령어 실패 시 `py` 런처로 자동 재시도하는 폴백(Fallback) 로직 추가
  - (추가) 배치 파일 인코딩/문법 오류 가능성을 배제하기 위해 모든 한글 주석 및 출력문을 영문으로 변경하고 로직을 최소화
- **재발 방지**: 배치 파일이 원인 불명으로 즉시 종료될 때는 인코딩 문제나 문법 오류일 가능성이 높으므로, 내용을 단순화하고 영문으로 변경하여 디버깅해야 함

- **변경 대상**: `run_newsletter.bat`, `run_scheduler.bat`, `run_weekly_newsletter.bat`, `setup_scheduler.bat`, `stop_newsletter.bat`
- **유형**: [리팩토링], [오류수정]
- **문제 요약**: `start_web_app.bat`와 동일한 인코딩 문제 및 실행 지연/종료 현상 예방 필요
- **수정 내용**:
  - 모든 `.bat` 파일에서 한글 주석 및 출력문 제거 (영문으로 변경)
  - `python` 명령어 우선 사용 및 `py` 런처 폴백 로직 통일
  - 복잡한 분기 로직 단순화
  - 실행 종료 후 창이 닫히지 않도록 `pause` 추가 (스케줄러용 로직 제외)
- **재발 방지**: 프로젝트 내 모든 배치 파일은 동일한 안정성 기준(영문, 단순화, 폴백)을 적용하여 관리해야 함

- **변경 대상**: `newsletter_system.py`, `news_summarizer_v2.py`
- **유형**: [오류수정], [기능개선]
- **문제 요약**: 뉴스레터 발송 결과에서 Executive Summary 영역 마지막 부분에 불필요한 구분선(`---`)이 표기됨
- **수정 내용**:
  - `newsletter_system.py`: Executive Summary 파싱 시 끝부분의 구분선(`-`, `=`, `─`, `#`)을 반복적으로 제거하는 정제 로직 추가
  - `news_summarizer_v2.py`: Gemini API 응답 텍스트 전체에 대해서도 동일한 후처리 정제 로직 적용 (이중 안전장치)
- **재발 방지**: LLM 생성 텍스트는 항상 불필요한 마크다운 기호나 구분선이 포함될 수 있음을 가정하고, 파싱 단계에서 철저히 정제(Sanitization)해야 함

- **변경 대상**: `weekly_newsletter.html`
- **유형**: [기능개선]
- **문제 요약**: 주간 뉴스레터 폰트 사이즈가 일간 뉴스레터와 달라 디자인 일관성 부족
- **수정 내용**: `weekly_newsletter.html` 폰트 사이즈를 `daily_newsletter` 템플릿과 일치하도록 조정
  - Header Meta: 13px -> 12px
  - Header Title: 36px -> 28px
  - Header Subtitle: 18px -> 15px
  - Focus Title: 22px -> 19px
  - Focus Text: 16px -> 15px
  - Weekly Item Title: 18px -> 19px
  - Footer Text: 14px -> 13px
- **재발 방지**: 템플릿 간 디자인 일관성을 위해 공통 스타일 가이드를 준수해야 함

- **변경 대상**: `weekly_newsletter.html`
- **유형**: [기능개선]
- **문제 요약**: 주간 뉴스레터의 좌우 여백(Padding)이 일간 뉴스레터보다 넓어 콘텐츠 폭이 좁아 보이는 문제
- **수정 내용**: `weekly_newsletter.html`의 Padding 및 Wrapper Spacing을 `daily_newsletter`와 동일하게 조정
  - Wrapper Padding: 40px -> 20px
  - Header/Footer/Content Padding: 48px/30px -> 20px (좌우)
  - Mobile Padding: 24px -> 20px
- **재발 방지**: 템플릿 간 레이아웃 수치(Margin, Padding)를 통일하여 일관된 사용자 경험 제공

- **변경 대상**: `weekly_newsletter.html`
- **유형**: [기능개선]
- **문제 요약**: 주간 뉴스레터에 단신 모음(In Other News) 섹션이 없어 정보의 다양성이 부족함
- **수정 내용**: `daily_newsletter`와 동일한 스타일의 "In Other News" 섹션을 하단에 추가
  - CSS 스타일 추가 (`.other-news-list`, `.number-badge` 등)
  - HTML 구조 추가 (Top 10 Insights 섹션 하단)
  - 예시 데이터 5건 포함 (번호 1~5로 설정)
- **변경 대상**: `weekly_newsletter.html`
- **유형**: [기능개선]
- **문제 요약**: 주간 뉴스레터의 폰트 사이즈가 일간 뉴스레터와 미세하게 달라 통일감 부족
- **수정 내용**: `daily_newsletter`와 폰트 사이즈 및 굵기를 정밀하게 일치시킴
  - Focus Label: 12px/800 -> 13px/700
  - Focus Title: 19px -> 18px
  - Section Title: 22px/800 -> 18px/700
  - Weekly Item Title: 19px/700 -> 16px/600
  - Weekly Num: 28px -> 24px (타이틀 크기 축소에 맞춰 조정)
  - Mobile Focus Title: 17px -> 16px
- **변경 대상**: `weekly_newsletter.html`
- **유형**: [기능개선]
- **문제 요약**: Top 10 Insights 리스트 아이템 간의 간격이 너무 넓음
- **수정 내용**: 아이템 간 여백(Margin/Padding) 축소
  - Margin Bottom: 32px -> 20px
  - Padding Bottom: 24px -> 20px
- **재발 방지**: 템플릿 확장 시 기존 템플릿의 유용한 섹션을 적극적으로 재사용하여 통일성 유지

- **변경 대상**: `templates/weekly_newsletter.html`
- **유형**: [오류수정], [기능개선]
- **문제 요약**:
  - `weekly_generator.py`에서 사용하는 CSS 클래스명(`weekly-desc`)과 템플릿의 클래스명(`weekly-item-desc`)이 불일치
  - 템플릿 가이드(`weekly_insight_top10_snippet.html`)에 있는 `top-10-list` 컨테이너가 누락되어 구조적 일관성 부족
- **수정 내용**:
  - CSS 클래스명 통일: `.weekly-item-desc` → `.weekly-desc` (line 181)
  - Top 10 Insights 섹션에 `<div class="top-10-list">` 컨테이너 추가 (line 308-310)
  - 템플릿 가이드(`weekly_insight_top10_snippet.html`)와 완전히 일치하도록 구조 재정비
- **재발 방지**:
  - 템플릿 파일과 생성 로직 간의 클래스명/구조 일치 여부를 반드시 크로스체크해야 함
  - 템플릿 가이드 파일이 존재하는 경우, 해당 가이드를 기준으로 구조를 맞춰야 함

- **변경 대상**: `weekly_generator.py`
- **유형**: [기능개선]
- **문제 요약**:
  - Top 10 뉴스 아이템에 출처/날짜가 표시되어 있으나, 사용자가 관련 뉴스를 찾기 어려움
  - Daily Newsletter처럼 앵커 링크를 통해 In Other News 섹션으로 이동하는 기능 필요
- **수정 내용**:
  - Top 10 아이템의 출처/날짜 표기를 '관련 기사 {rank}' 앵커 링크로 교체
  - 각 Top 10 아이템의 rank 번호를 사용하여 In Other News의 해당 뉴스(#news-{rank})로 이동
  - 링크 스타일: 보라색(#5e2bb8), 밑줄 없음
- **재발 방지**:
  - 사용자 경험 개선을 위해 관련 콘텐츠 간 내비게이션 기능을 적극 활용해야 함
  - Daily/Weekly Newsletter 간 일관된 UX 패턴 유지

- **변경 대상**: `weekly_generator.py`
- **유형**: [기능개선]
- **문제 요약**:
  - '관련 기사' 링크가 일반 텍스트 형태로 표시되어 클릭 가능한 요소임을 인지하기 어려움
  - In Other News가 AI가 별도로 선정한 뉴스여서 Top 10과 연관성이 없음
- **수정 내용**:
  - '관련 기사' 링크를 뱃지 형태로 스타일 변경
    - 보라색 배경(#5e2bb8), 흰색 텍스트, 둥근 모서리(border-radius: 4px)
    - 패딩 추가로 클릭 영역 확대
    - 번호 형식: {rank:02d} (01, 02, ... 10)
  - In Other News를 Top 10과 동일한 뉴스로 변경
    - `curated_result.get('other_news', [])` → `curated_result.get('top_10', [])`
    - Top 10의 각 아이템이 In Other News의 해당 번호와 1:1 매핑
- **재발 방지**:
  - UI 요소의 affordance(행동 유도성)를 명확히 하여 사용자가 클릭 가능한 요소를 쉽게 인지하도록 해야 함
  - 관련 콘텐츠 간의 일관성을 유지하여 사용자 혼란 방지

- **변경 대상**: `weekly_generator.py`
- **유형**: [기능개선]
- **문제 요약**: 주간 뉴스레터가 테스트 모드로 설정되어 실제 메일 발송이 되지 않음
- **수정 내용**:
  - 메일 발송 라인 주석 해제 (line 105)
  - 테스트 모드 로그 및 강제 성공 처리 주석 처리 (lines 106-107)
  - 로그 메시지 변경: "생성 완료 (발송 생략)" → "발송 완료"
- **재발 방지**: 프로덕션 배포 전 테스트 모드 해제 여부를 반드시 확인해야 함

- **변경 대상**: `weekly_generator.py`
- **유형**: [디자인수정]
- **문제 요약**: '관련 기사' 뱃지 디자인을 더 심플하고 전문적으로 변경 요청
- **수정 내용**:
  - 텍스트 삭제: "관련 기사 01" → "1" (숫자만 표기)
  - 색상 변경: 보라색(#5e2bb8) → 짙은 회색(#334155)
  - 숫자 포맷: 2자리(01) → 1자리(1) (앞의 0 제거)
  - In Other News의 숫자 뱃지도 동일하게 1자리 포맷으로 변경
- **재발 방지**: 디자인 가이드라인을 명확히 하여 초기 개발 시 반영

- **변경 대상**: `weekly_generator.py`
- **유형**: [디자인수정]
- **문제 요약**: '관련 기사' 뱃지가 별도의 줄에 위치하여 가독성이 떨어짐
- **수정 내용**:
  - 위치 변경: 요약문(`p.weekly-desc`) 내부의 텍스트 끝으로 이동 (인라인 배치)
  - 스타일 변경:
    - 배경색: 연한 회색(#f8fafc)
    - 글자색: 짙은 회색(#475569)
    - 테두리: 얇은 회색(#e2e8f0) 추가
    - 크기 및 여백 조정 (padding: 1px 6px, margin-left: 4px)
- **재발 방지**: 텍스트와 연관된 메타데이터는 인라인 배치를 우선 고려

- **변경 대상**: `weekly_generator.py`
- **유형**: [버그수정]
- **문제 요약**: 메일 발송 시 레이아웃 깨짐 현상 발생 (Outlook 등에서 Flexbox 미지원)
- **수정 내용**:
  - Top 10 리스트: `div` + Flexbox 구조를 `table` 구조로 변경
  - In Other News 리스트: `ul/li` + Flexbox 구조를 `table` 구조로 변경
  - 스타일: 주요 스타일(폰트, 색상, 정렬 등)을 인라인 스타일로 적용하여 호환성 강화
- **재발 방지**: 이메일 템플릿 개발 시 Flexbox 대신 Table 레이아웃 사용을 원칙으로 함

---

## 2026-01-20

- **변경 대상**: `newsletter_system.py`, `web_app.py`
- **유형**: [오류수정], [기능개선]
- **문제 요약**: 뉴스레터 생성 및 발송 버튼 클릭 시 크롤링이 진행되지 않음
- **근본 원인**:
  - 이전 실행 시 생성된 `newsletter.lock` 파일이 비정상 종료로 인해 삭제되지 않고 남아있음
  - Lock 파일 존재 시 30분 이내 재실행을 차단하는 로직으로 인해 새로운 크롤링 시도가 거부됨
  - 사용자가 Lock 파일 존재 여부를 확인할 수 없어 원인 파악이 어려움
- **수정 내용**:
  - `newsletter_system.py` (line 367-378):
    - Lock 파일 타임아웃 단축: 30분(1800초) → 10분(600초)
    - Lock 파일 존재 시 경과 시간 및 재시도 가능 시간을 로그에 명시
  - `web_app.py` (line 99-142):
    - `/api/status` 엔드포인트에 Lock 파일 정보 추가 (exists, elapsed_minutes, can_retry)
  - `web_app.py` (line 238-262):
    - `/api/clear-lock` 엔드포인트 추가 (사용자가 수동으로 Lock 파일 제거 가능)
  - 기존 Lock 파일 수동 제거 완료
- **재발 방지**:
  - Lock 파일 타임아웃을 짧게 유지하여 사용자 대기 시간 최소화
  - UI에서 Lock 파일 상태를 실시간으로 표시하여 투명성 확보
  - 비정상 종료 시 Lock 파일이 남을 수 있음을 인지하고, 수동 제거 기능 제공
  - 프로세스 시작/종료 시 Lock 파일 생성/삭제가 정상적으로 이루어지는지 모니터링 필요

---

## 2026-01-21

- **변경 대상**: `weekly_generator.py`
- **유형**: [기능개선]
- **문제 요약**: 주간 뉴스레터 Top 10 리스트의 숫자 배지 클릭 시 'In Other News' 섹션으로 이동(앵커 링크)하여 사용자 경험이 단절됨
- **수정 내용**:
  - 숫자 배지의 링크(`href`)를 내부 앵커(`#news-{rank}`)에서 뉴스 원문 링크(`item.get('link')`)로 변경
  - `target="_blank"` 속성을 유지하여 새 창에서 열리도록 설정
- **재발 방지**: 사용자가 직관적으로 기대하는 동작(뉴스 보기)에 맞춰 링크 대상을 설정해야 함

---

## 2026-01-22

- **변경 대상**: `news_summarizer_v2.py`
- **유형**: [오류수정], [기능개선]
- **문제 요약**:
  - 뉴스레터 발송 결과가 매번 달라지는 불안정성 문제
  - Executive Summary가 간헐적으로 빈 공간으로 제공됨
  - AI 응답 품질이 낮을 때 검증 없이 그대로 사용됨
- **수정 내용**:
  - `summarize_all_news()` 메서드에 재시도 로직 추가 (최대 3회 시도)
  - `_validate_executive_summary()` 메서드 추가:
    - 빈 요약 검사
    - 최소 길이 검사 (100자 이상)
    - 최대 길이 경고 (500자 초과 시)
  - 재시도 시 더 명확한 지시사항 자동 추가 및 temperature 낮춤 (0.5 → 0.3)
- **재발 방지**:
  - LLM 출력은 항상 품질 검증이 필요함
  - 품질 미달 시 재시도 로직을 통해 안정성 확보
  - 재시도 시 파라미터 조정(temperature 등)으로 품질 향상

- **변경 대상**: `newsletter_system.py`
- **유형**: [오류수정], [기능개선]
- **문제 요약**:
  - 개별 뉴스 요약이 제목과 동일하거나 거의 유사한 내용으로 제공되는 문제 빈번히 발생
  - AI가 프롬프트 지시를 무시하고 제목을 복사
  - 품질 미달 시 대체 수단 부재
- **수정 내용**:
  - `_format_cards_v3()` 메서드 개선:
    - 원본 뉴스 링크 매핑 생성 (`link_to_news`)
    - AI가 생성한 카드와 원본 뉴스를 연결
    - 원본 뉴스 데이터를 `_create_card_html_v3()`에 전달
  - `_create_card_html_v3()` 메서드 개선:
    - `original_news` 파라미터 추가하여 원본 뉴스 데이터 수신
    - 요약 품질 검사 로직 강화:
      - 제목과 요약 완전 일치 검사
      - 제목과 요약 유사도 검사 (추가 정보가 제목의 30% 미만이면 미흡 판정)
      - 요약 최소 길이 검사 (20자 이상)
    - **Fallback 메커니즘 추가**:
      - 품질이 낮을 때 원본 뉴스의 `content_preview` 또는 `full_content` 사용
      - 200자로 제한, 마침표 기준으로 잘림 방지
      - Fallback 실패 시 해당 카드 자동 제외
  - Fallback 카드 생성 시 요약 품질 향상:
    - 문장 중간 잘림 방지 로직 추가
    - 원본 뉴스 데이터를 전달하여 추가 검증 가능
- **재발 방지**:
  - AI 생성 콘텐츠의 품질은 항상 검증해야 함
  - 품질 미달 시 원본 데이터를 활용한 Fallback 메커니즘 필수
  - 제목과 요약의 유사도를 정량적으로 측정하여 객관적 판단

- **변경 대상**: `prompts/newsletter_template_prompt.md`
- **유형**: [기능개선]
- **문제 요약**:
  - 프롬프트 지시사항이 불명확하여 AI가 제목을 복사하거나 품질 낮은 요약 생성
  - Executive Summary 최소 길이 명시 부재
- **수정 내용**:
  - **Executive Summary 섹션 대폭 개선**:
    - 최소 글자수 명시 (100자 이상)
    - 권장 글자수 범위 제시 (150~300자)
    - 빈 요약 작성 금지 경고 추가
    - 구체적인 작성 예시 추가
  - **뉴스 요약 섹션 대폭 강화**:
    - **제목 복사 금지 규칙** 시각적 강조 (🚨 이모지 사용)
    - 4가지 명확한 규칙 명시:
      1. 요약은 제목과 완전히 다른 내용
      2. 제목의 단어를 그대로 복사 금지
      3. 기사 본문에서 구체적인 정보 추출
      4. 제목에 없는 정보 반드시 포함
    - 금지 예시 3개 추가 (실제 발생한 문제 패턴 기반)
    - 올바른 예시 3개 추가 (구체적인 작성법 제시)
    - 5W1H 원칙 적용 명시
    - 구체적인 사실과 수치 포함 요구 강화
  - **최종 체크리스트 추가**:
    - Executive Summary 체크 항목 (3개)
    - 뉴스 요약 체크 항목 (4개)
    - 일반 주의사항 체크 항목 (5개)
- **재발 방지**:
  - LLM에게 지시할 때는 추상적인 규칙보다 **구체적인 예시(Few-shot)**가 훨씬 효과적
  - 시각적 강조(이모지, 구분선)로 중요 규칙 인지도 향상
  - 체크리스트 제공으로 AI가 자가 검증하도록 유도

- **변경 대상**: `newsletter_system.py`
- **유형**: [오류수정]
- **문제 요약**:
  - 표(Table) 형식 감지 시 Fallback이 작동하지만 생성된 카드가 품질 검증에서 재차 거부됨
  - Fallback 카드가 `_create_card_html_v3()` 품질 검증을 통과하지 못하여 0~1개 카드만 생성됨
  - 원본 뉴스의 `summary`가 `title`과 동일하여 검증 실패 → Fallback 재시도 → `content_preview`가 부족/동일하여 최종 실패
  - 결과: TECH/AI/BIZ 각 카테고리에서 5개가 아닌 0~1개만 표시됨
- **수정 내용**:
  - `_format_cards_v3()` 메서드의 Fallback 섹션 (표 형식 감지 시, AI 파싱 부족 시) 수정:
    - `_create_card_html_v3()` 호출 시 `skip_validation=True` 파라미터 추가
  - `_create_card_html_v3()` 메서드 시그니처 및 로직 수정:
    - `skip_validation=False` 파라미터 추가
    - `skip_validation=True`일 경우 품질 검증 로직 전체를 건너뜀
    - Fallback으로 생성된 카드는 이미 원본 데이터(`content_preview`/`full_content`)를 사용하므로 재검증 불필요
- **재발 방지**:
  - Fallback 메커니즘이 다단계로 중첩될 때, 이미 Fallback 처리된 데이터를 다시 검증하면 무한 루프 또는 전체 거부 현상 발생 가능
  - Fallback 데이터에는 별도의 품질 검증 우회 플래그(`skip_validation` 등)를 제공하여 재검증을 방지해야 함
  - 로그를 통해 Fallback 실패 원인(데이터 부족, 중복 검증 등)을 명확히 추적해야 함

---

## 2026-02-03

- **변경 대상**: `newsletter_system.py`
- **유형**: [오류수정]
- **문제 요약**: 뉴스레터 카테고리별 뉴스(5~11번 등)의 요약 내용과 실제 연결된 링크가 일치하지 않는(Mismatch) 현상 발생
- **원인 분석**:
  - AI 요약 엔진은 **'전체 통합 리스트'**를 기준으로 ID를 부여함
  - 시스템은 **'카테고리별 리스트'**에서 해당 ID를 조회함
  - 두 리스트의 인덱스 기준이 달라 엉뚱한 뉴스가 연결됨
- **수정 내용**:
  - `newsletter_system.py` 내에 `news_summarizer_v2.py`가 사용하는 것과 동일한 로직으로 `reference_news_list`(전체 통합 리스트)를 생성
  - 링크 매핑 시 카테고리별 리스트가 아닌, 이 `reference_news_list`를 참조하여 ID를 찾도록 로직 변경
- **재발 방지**:
  - AI가 생성한 인덱스(ID)를 사용할 때는 반드시 AI가 참조한 데이터셋과 **동일한 순서와 구성**을 가진 데이터셋을 사용해야 함
